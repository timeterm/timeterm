include:
  - template: Dependency-Scanning.gitlab-ci.yml

variables:
  DOCKER_TLS_CERTDIR: "/certs"

services:
  - docker:19.03.13-dind

stages:
  - build
  - test
  - deploy

build-backend:
  stage: build
  image: registry.gitlab.com/timeterm/timeterm/golang-build
  variables:
    PACKAGE: "backend"
  script:
    - cd backend
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - make image push
  only:
    refs:
      - master
    # changes:
    #   - "backend/**/*"

build-oci-nats-jsm-backup:
  stage: build
  image: registry.gitlab.com/timeterm/timeterm/docker-build
  variables:
    PACKAGE: "oci-nats-jsm-backup"
  script:
    - cd oci-images/nats-jsm-backup
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - make image push
  only:
    refs:
      - master
    # changes:
    #   - "oci-images/nats-jsm-backup/**/*"

build-oci-postgres-backup:
  stage: build
  image: registry.gitlab.com/timeterm/timeterm/docker-build
  variables:
    PACKAGE: "oci-postgres-backup"
  script:
    - cd oci-images/postgres-backup
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - make image push
  only:
    refs:
      - master
    # changes:
    #   - "oci-images/postgres-backup/**/*"

build-frontend-admin-web:
  stage: build
  image: registry.gitlab.com/timeterm/timeterm/react-build
  variables:
    PACKAGE: "frontend-admin-web"
  script:
    - cd frontend-admin-web
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - yarn install
    - make image push
  only:
    refs:
      - master
    # changes:
    #   - "frontend-admin-web/**/*"

build-api-reference:
  stage: build
  image: registry.gitlab.com/timeterm/timeterm/docker-build
  variables:
    PACKAGE: "api-reference"
  script:
    - cd api/reference
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - make image push
  only:
    refs:
      - master
    # changes:
    #   - "api/reference/**/*"

build-docs:
  stage: build
  image: registry.gitlab.com/timeterm/timeterm/hugo-build
  variables:
    PACKAGE: "docs"
  script:
    - cd docs
    - git submodule update --init themes/book
    - make build
  artifacts:
    paths:
      - docs/public/
  only:
    refs:
      - master
    # changes:
    #   - "docs/**/*"

deploy-docs:
  stage: deploy
  image: docker:19.03.13
  variables:
    PACKAGE: "docs"
  dependencies:
    - build-docs
  script:
    - cd docs
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - make image push
  only:
    refs:
      - master
    # changes:
    #   - "docs/**/*"

