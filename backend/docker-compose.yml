version: '3'

services:
  postgres:
    image: postgres:13.0-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: timeterm
    restart: on-failure

  adminer:
    image: adminer:latest
    restart: always
    ports:
      - "8432:8080"

  nats:
    image: synadia/jsm:nightly-20201116
    restart: always
    environment:
      NATS_CONFIG: |
        operator: /operator/TIMETERM.jwt
        resolver: URL(http://nats-account-server:9090/jwt/v1/accounts/)
        system_account: ADHWTMMB6WMKDGJOTIXLXV56DIHVPV46K7UTVUXJRQ2NHL6DWEOU35UG

        jetstream {
          store_dir: datastore
        }
    volumes:
      - ./nm/store/TIMETERM/TIMETERM.jwt:/operator/TIMETERM.jwt
    entrypoint: /bin/sh -c "echo \"$$NATS_CONFIG\" > /nats.config && /nats-server -c /nats.config"
    ports:
      - "4222:4222"
  
  nats-account-server:
    environment:
      NAS_CONFIG: |
        operatorjwtpath: /data/TIMETERM.jwt
        systemaccountjwtpath: /data/accounts/SYS/SYS.jwt

        store: {
          nsc: /data
        }

        http {
          host: 0.0.0.0
          port: 9090
        }
    volumes:
      - ./nm/store/TIMETERM:/data
    image: synadia/nats-account-server:0.8.4
    restart: always
    entrypoint: /bin/sh -c "echo \"$$NAS_CONFIG\" > /nas.config && nats-account-server -c /nas.config"
    ports:
      - "9090:9090"
  
  vault:
    image: vault
    environment:
      VAULT_CONFIG: |
        {"ui": true, "backend": {"file": {"path": "/vault/file"}}, "default_lease_ttl": "168h", "max_lease_ttl": "720h", "listener": {"tcp": {"address": "0.0.0.0:8300", "tls_disable": 1}}}
    entrypoint: /bin/sh -c "echo \"$$VAULT_CONFIG\" > /vault/config/config.hcl && vault server -config /vault/config/config.hcl"
    ports:
      - "8300:8300"
    cap_add:
      - IPC_LOCK
